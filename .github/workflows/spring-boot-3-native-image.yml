name: spring-boot-3-native-image
on:
  push:
    paths:
      - 'spring-boot-3-native-image/**'
      - '.github/workflows/spring-boot-3-native-image.yml'
  pull_request:
    paths:
      - 'spring-boot-3-native-image/**'
      - '.github/workflows/spring-boot-3-native-image.yml'
  schedule:
    - cron: "0 0 1 * *" # run every month
  workflow_dispatch:
permissions:
  contents: read
jobs:
  run:
    name: Run 'spring-boot-3-native-graal'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - uses: graalvm/setup-graalvm@v1
        with:
          version: 'dev'
          java-version: '17'
          components: 'native-image'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'
      - name: Run 'spring-boot-3-native-image'
        run: |
          cd spring-boot-3-native-image
          #
          # Setup musl toolchain
          #
          #./setup-musl.sh
          
          # Download musl
          wget http://more.musl.cc/10/x86_64-linux-musl/x86_64-linux-musl-native.tgz
          tar -xzf x86_64-linux-musl-native.tgz
          rm x86_64-linux-musl-native.tgz
          export TOOLCHAIN_DIR=`pwd`/x86_64-linux-musl-native
          export CC=${TOOLCHAIN_DIR}/bin/gcc
          
          # Download, build, install zlib into TOOLCHAIN_DIR
          wget https://zlib.net/zlib-1.2.12.tar.gz
          tar -xzf zlib-1.2.12.tar.gz
          rm zlib-1.2.12.tar.gz
          cd zlib-1.2.12
          ./configure --prefix=${TOOLCHAIN_DIR} --static
          make
          make install
          cd ..
          
          # Add TOOLCHAIN_DIR to PATH
          export PATH=${TOOLCHAIN_DIR}/bin:${PATH}
          
          #
          # Spring Native compilation
          #
          mvn --no-transfer-progress native:compile -Pnative package
          echo "Generated Executables"
          ls -lh ./target/benchmark-jibber
          ./target/benchmark-jibber &
          sleep 5
          curl http://localhost:8080/jibber
